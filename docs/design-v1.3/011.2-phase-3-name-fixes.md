# Phase 3: Naming Convention Fixes

**Project**: erlmd (Erlang Markdown Parser)
**Document**: Refactoring Plan for Module Name Consistency
**Date**: November 14, 2025
**Related**: Phase 3 Implementation (011-phase-3-simple-constructs-guide.md)

---

## Background

The implementation of Phase 3 used inconsistent naming conventions that don't align with the earlier design documents (002, 007, 008). This document outlines the refactoring needed to achieve consistency.

### Naming Convention Standards

As defined in earlier design documents, the erlmd project uses abbreviated module names to keep file names short and readable:

- **Construct modules**: `erlmd_cnstr_*` (not `erlmd_construct_*`)
- **Partial construct modules**: `erlmd_cnstr_prtl_*` (not `erlmd_construct_partial_*`)
- **Private/internal modules**: `erlmd_pvt_*` (not `*_internal`)
- **Utility modules**: `erlmd_util_*`

### Current Inconsistencies

Phase 3 implementation used the full names:
- ❌ `erlmd_construct_partial_data`
- ❌ `erlmd_construct_partial_space_or_tab`
- ❌ `erlmd_construct_blank_line`

Should be:
- ✅ `erlmd_cnstr_prtl_data`
- ✅ `erlmd_cnstr_prtl_space_or_tab`
- ✅ `erlmd_cnstr_blank_line`

---

## Refactoring Tasks

### 1. Source File Renames

| Current File | New File | Type |
|-------------|----------|------|
| `src/erlmd_construct_partial_data.erl` | `src/erlmd_cnstr_prtl_data.erl` | Partial construct |
| `src/erlmd_construct_partial_space_or_tab.erl` | `src/erlmd_cnstr_prtl_space_or_tab.erl` | Partial construct |
| `src/erlmd_construct_blank_line.erl` | `src/erlmd_cnstr_blank_line.erl` | Regular construct |

### 2. Test File Renames

| Current Test File | New Test File |
|------------------|---------------|
| `test/erlmd_construct_partial_data_test.erl` | `test/erlmd_cnstr_prtl_data_test.erl` |
| `test/erlmd_construct_partial_space_or_tab_test.erl` | `test/erlmd_cnstr_prtl_space_or_tab_test.erl` |
| `test/erlmd_construct_blank_line_test.erl` | `test/erlmd_cnstr_blank_line_test.erl` |

### 3. Module Name Updates

Each renamed file requires updating the `-module()` directive:

**erlmd_cnstr_prtl_data.erl:**
```erlang
-module(erlmd_cnstr_prtl_data).
```

**erlmd_cnstr_prtl_space_or_tab.erl:**
```erlang
-module(erlmd_cnstr_prtl_space_or_tab).
```

**erlmd_cnstr_blank_line.erl:**
```erlang
-module(erlmd_cnstr_blank_line).
```

### 4. References to Update

All files that reference the old module names must be updated:

#### 4.1 State Dispatcher (`src/erlmd_state.erl`)

Update all `call/2` function clauses that reference construct modules:

**Before:**
```erlang
call(partial_data, T) ->
    erlmd_construct_partial_data:start(T);
```

**After:**
```erlang
call(partial_data, T) ->
    erlmd_cnstr_prtl_data:start(T);
```

#### 4.2 Tokenizer (`src/erlmd_tokenizer.erl`)

Search for and update any direct references to construct modules (if any exist).

#### 4.3 Test Files

Update all test module names and imports:

**Before (erlmd_construct_partial_data_test.erl):**
```erlang
-module(erlmd_construct_partial_data_test).
-include_lib("eunit/include/eunit.hrl").

simple_data_test() ->
    T = test_helper:make_tokenizer(<<"Hello">>),
    {ok, T1} = erlmd_construct_partial_data:start(T),
    ...
```

**After (erlmd_cnstr_prtl_data_test.erl):**
```erlang
-module(erlmd_cnstr_prtl_data_test).
-include_lib("eunit/include/eunit.hrl").

simple_data_test() ->
    T = test_helper:make_tokenizer(<<"Hello">>),
    {ok, T1} = erlmd_cnstr_prtl_data:start(T),
    ...
```

#### 4.4 Integration Tests

Update references in:
- `test/erlmd_integration_test.erl`
- `test/erlmd_tokenizer_test.erl`
- Any other files that reference the construct modules

#### 4.5 Documentation

Update Phase 3 guide to use correct naming:
- `docs/design-v1.3/011-phase-3-simple-constructs-guide.md`
- `docs/design-v1.3/011.1-phase-3-fix-guide.md`

---

## Implementation Steps

### Step 1: Rename Source Files

```bash
cd src
git mv erlmd_construct_partial_data.erl erlmd_cnstr_prtl_data.erl
git mv erlmd_construct_partial_space_or_tab.erl erlmd_cnstr_prtl_space_or_tab.erl
git mv erlmd_construct_blank_line.erl erlmd_cnstr_blank_line.erl
```

### Step 2: Rename Test Files

```bash
cd test
git mv erlmd_construct_partial_data_test.erl erlmd_cnstr_prtl_data_test.erl
git mv erlmd_construct_partial_space_or_tab_test.erl erlmd_cnstr_prtl_space_or_tab_test.erl
git mv erlmd_construct_blank_line_test.erl erlmd_cnstr_blank_line_test.erl
```

### Step 3: Update Module Declarations

For each renamed source file:
1. Update the `-module()` directive to match new file name
2. Keep all other content identical

### Step 4: Update Test Module Declarations

For each renamed test file:
1. Update the `-module()` directive
2. Update all function calls to use new module names
3. Keep test logic identical

### Step 5: Update erlmd_state.erl

Update the state dispatcher to reference new module names:
- `erlmd_construct_partial_data` → `erlmd_cnstr_prtl_data`
- `erlmd_construct_partial_space_or_tab` → `erlmd_cnstr_prtl_space_or_tab`
- `erlmd_construct_blank_line` → `erlmd_cnstr_blank_line`

### Step 6: Search and Update All References

```bash
# Find all references to old names
grep -r "erlmd_construct_partial_data" src/ test/
grep -r "erlmd_construct_partial_space_or_tab" src/ test/
grep -r "erlmd_construct_blank_line" src/ test/
```

Update each reference found.

### Step 7: Verify Compilation

```bash
rebar3 clean
rebar3 compile
```

Should compile with no errors or warnings.

### Step 8: Run All Tests

```bash
rebar3 eunit
```

All tests should pass with updated names.

### Step 9: Update Documentation

Update the following documentation files:
- `docs/design-v1.3/011-phase-3-simple-constructs-guide.md`
- `docs/design-v1.3/011.1-phase-3-fix-guide.md`

Replace all instances of old naming with new naming.

---

## Verification Checklist

After completing all steps, verify:

- [ ] All source files renamed (3 files)
- [ ] All test files renamed (3 files)
- [ ] All `-module()` directives updated
- [ ] `erlmd_state.erl` references updated
- [ ] No references to old names in `src/`
- [ ] No references to old names in `test/`
- [ ] `rebar3 compile` succeeds with no warnings
- [ ] `rebar3 eunit` passes all tests
- [ ] Documentation files updated
- [ ] No broken cross-references in documentation

---

## Search Patterns for Verification

Use these to ensure complete refactoring:

```bash
# Should return NO results after refactoring:
grep -r "erlmd_construct_partial_data" . --exclude-dir=_build
grep -r "erlmd_construct_partial_space_or_tab" . --exclude-dir=_build
grep -r "erlmd_construct_blank_line" . --exclude-dir=_build

# Should find NEW names in correct places:
grep -r "erlmd_cnstr_prtl_data" src/ test/
grep -r "erlmd_cnstr_prtl_space_or_tab" src/ test/
grep -r "erlmd_cnstr_blank_line" src/ test/
```

---

## Future Constructs

For all future construct implementations (Phase 4+), use the correct naming from the start:

### Regular Constructs
- ✅ `erlmd_cnstr_heading_atx`
- ✅ `erlmd_cnstr_thematic_break`
- ✅ `erlmd_cnstr_paragraph`
- ✅ `erlmd_cnstr_code_fenced`

### Partial Constructs
- ✅ `erlmd_cnstr_prtl_label`
- ✅ `erlmd_cnstr_prtl_title`
- ✅ `erlmd_cnstr_prtl_whitespace`

### Content Type Dispatchers
- ✅ `erlmd_cnstr_document`
- ✅ `erlmd_cnstr_flow`
- ✅ `erlmd_cnstr_text`
- ✅ `erlmd_cnstr_string`

---

## Risk Assessment

**Risk Level**: Low

- Simple rename operation
- No logic changes
- Tests verify correctness
- Git tracks file renames

**Mitigation**:
- Use `git mv` to preserve history
- Update all references atomically
- Run full test suite before committing
- Keep this document as reference

---

## Estimated Time

- **File renames**: 5 minutes
- **Module directive updates**: 10 minutes
- **Reference updates**: 15 minutes
- **Testing and verification**: 10 minutes
- **Documentation updates**: 10 minutes

**Total**: ~50 minutes

---

## Notes

- This refactoring must be completed before Phase 4 begins
- Use this as a template for any future naming inconsistencies
- The abbreviated naming convention reduces cognitive load and improves code navigation
- See `012-naming-conventions.md` for comprehensive naming guidelines

---

*Document created: November 14, 2025*
*Related: Phase 3 Implementation*
*Status: Ready for execution*
